{% extends 'main/base.html' %}
{% block title %}General Transactions{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>General Transactions</h2>
    {% if transactions %}
    <table id="transactionsTable" class="table table-striped">
        <thead>
            <tr>
                <th>Donor Name</th>
                <th>Amount</th>
                <th>Type</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transactions %}
            <tr>
                <td>{{ transaction.donor_name }}</td>
                <td>${{ transaction.amount }}</td>
                <td>{{ transaction.transaction_type }}</td>
                <td>{{ transaction.date }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="button-container">
        <button onclick="downloadTableAsCSV()" class="btn btn-secondary mt-3">Download as CSV</button>
        <button onclick="downloadTableAsPDF()" class="btn btn-secondary mt-3">Download as PDF</button>
    </div>
    <script>
        function downloadTableAsCSV() {
            const table = document.getElementById("transactionsTable");
            let csvContent = "General Fund Transactions\n\n";

            // Get table headers
            const headers = Array.from(table.querySelectorAll("thead th"))
                .map(header => header.textContent.trim())
                .join(",");
            csvContent += headers + "\n";

            // Get table rows and remove any non-numeric characters from Amount
            const rows = Array.from(table.querySelectorAll("tbody tr"));
            rows.forEach(row => {
                const rowData = Array.from(row.querySelectorAll("td")).map((cell, index) => {
                    let cellContent = cell.textContent.trim();

                    return `"${cellContent}"`; // Enclose each cell content in double quotes
                }).join(",");
                csvContent += rowData + "\n";
            });

            // Create a Blob from the CSV string
            const blob = new Blob([csvContent], { type: "text/csv" });
            const url = URL.createObjectURL(blob);

            // Create a temporary link and trigger the download
            const a = document.createElement("a");
            a.href = url;
            a.download = "General Transactions.csv";
            document.body.appendChild(a);
            a.click();

            // Clean up
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        function downloadTableAsPDF() {
            // Import jsPDF
            const { jsPDF } = window.jspdf;

            // Create a new jsPDF instance
            const doc = new jsPDF();

            // Get table element
            const table = document.getElementById("transactionsTable");

            if (!table) {
                console.error("Table with id 'transactions' not found!");
                return;
            }

            // Extract headers
            const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());

            // Extract data from rows
            const data = Array.from(table.querySelectorAll("tbody tr")).map(tr => {
                return Array.from(tr.querySelectorAll("td")).map(td => td.textContent.trim());
            });

            // Add title
            doc.text("General Fund Transactions", 14, 15);

            // Add table using autoTable
            doc.autoTable({
                head: [headers],
                body: data,
                startY: 20,
                styles: {
                    head: { fillColor: [95, 140, 166] }, // Customize header color
                    halign: 'left',
                },
            });

            // Save the PDF
            doc.save("General Transactions.pdf");
        };
    </script>

    <div id="graph"></div>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const table = document.getElementById("transactionsTable");
            //table.style.display = "none"; // Show table after sorting

            // Sort function for the "Date" column (first column)
            function sortTableByDate() {
                const rows = Array.from(table.querySelectorAll("tbody tr"));
                rows.sort((a, b) => {
                    const dateA = new Date(a.cells[3].textContent);
                    const dateB = new Date(b.cells[3].textContent);
                    return dateA - dateB;
                });

                // Append rows in sorted order
                rows.forEach(row => table.querySelector("tbody").appendChild(row));
            }

            sortTableByDate();

            // Set a new identifier for the sorted table
            table.setAttribute("id", "sortedTransactions");

            // Now we can safely reference "sortedTransactions"
            var donationTotal = 0;

            const sortedTable = document.getElementById("sortedTransactions");
            const rows = Array.from(sortedTable.querySelectorAll("tbody tr"));
            const data = rows.map(row => {
                const date = row.cells[3].innerText;
                const amount = parseFloat(row.cells[1].innerText.replace('$', ''));
                donationTotal += amount;
                return { date: new Date(date), amount: donationTotal };
            });

            // Set up dimensions and margins
            const margin = { top: 20, right: 30, bottom: 85, left: 60 };
            const width = 1000 - margin.left - margin.right;
            const height = 650 - margin.top - margin.bottom;

            // Create SVG container
            const svg = d3.select("#graph")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Set up scales
            const x = d3.scaleTime()
                .domain(d3.extent(data, d => d.date))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.amount)])
                .range([height, 0]);

            // Create line generator
            const line = d3.line()
                .x(d => x(d.date))
                .y(d => y(d.amount));

            // Add X and Y axes
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(5).tickFormat(d3.timeFormat("%Y-%m-%d")))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            svg.append("g")
                .call(d3.axisLeft(y));

            // Add labels for axes

            svg.append("text")
                .attr("text-anchor", "end")
                .attr("x", -margin.top)
                .attr("y", -margin.left + 15)
                .attr("transform", "rotate(-90)")
                .text("Total Amount in Fund (USD)")
                .style("fill", "black")
                .style("font-size", "12px");

            svg.append("text")
                .attr("text-anchor", "end")
                .attr("x", (width / 2) + 35)
                .attr("y", height + margin.bottom - 10)
                .text("Date of Transaction")
                .style("fill", "black")
                .style("font-size", "12px");

            // Add line path
            svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 2.5)
                .attr("d", line);
        });
    </script>
    {% else %}
    <p>No transactions found.</p>
    {% endif %}
    <div id="homebutton">
        <a href="{% url 'home' %}" class="btn btn-secondary mt-3">Back to Home</a>
    </div>
</div>
{% endblock %}