{% extends 'main/base.html' %}
{% block title %}View Project Transactions{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>Transactions for {{ project.name }}</h2>
    <p>Goal: ${{ project.goal_amount }}</p>
    <p>Raised So Far: ${{ total_raised }}</p>
    <table id="transactionsTable" class="table table-striped mt-3">
        <thead>
            <tr>
                <th>Date</th>
                <th>Donor Name</th>
                <th>Credit/Debit</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transactions %}
            <tr>
                <td>{{ transaction.date }}</td>
                <td>{{ transaction.donor_name }}</td>
                <td>{{ transaction.transaction_type }}</td>
                <td>${{ transaction.amount }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" class="text-center">No transactions yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="button-container">
        <button onclick="downloadTableAsCSV()" class="btn btn-secondary mt-3">Download as CSV</button>
        <button onclick="downloadTableAsPDF()" class="btn btn-secondary mt-3">Download as PDF</button>
    </div>

    <script>
        function downloadProjectTransactionsAsCSV() {
            const table = document.getElementById("transactionsTable");
            let csvContent = "";

            // Include project details at the top of the CSV
            const projectName = "{{ project.name }}";
            const goalAmount = "{{ project.goal_amount }}";
            const totalRaised = "{{ total_raised }}";

            csvContent += `Project Name:,${projectName}\n`;
            csvContent += `Goal:,"$${goalAmount}"\n`;
            csvContent += `Total Raised:,"$${totalRaised}"\n\n`;

            // Get table headers
            const headers = Array.from(table.querySelectorAll("thead th"))
                                 .map(header => header.textContent.trim())
                                 .join(",");
            csvContent += headers + "\n";

            // Get table rows and process data
            const rows = Array.from(table.querySelectorAll("tbody tr"));
            rows.forEach(row => {
                const rowData = Array.from(row.querySelectorAll("td")).map((cell, index) => {
                    let cellContent = cell.textContent.trim();

                    return `"${cellContent}"`; // Enclose each cell content in double quotes
                }).join(",");
                csvContent += rowData + "\n";
            });

            // Create a Blob from the CSV string
            const blob = new Blob([csvContent], { type: "text/csv" });
            const url = URL.createObjectURL(blob);

            // Create a temporary link and trigger the download
            const a = document.createElement("a");
            a.href = url;
            a.download = "Project Specific Transactions.csv";
            document.body.appendChild(a);
            a.click();

            // Clean up
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        function downloadTableAsPDF() {
            // Import jsPDF
            const { jsPDF } = window.jspdf;

            // Create a new jsPDF instance
            const doc = new jsPDF();

            // Add title
            doc.text("Project Specific Transactions", 70, 15);

            let currentY = 25

            // Define project details
            const projectName = "{{ project.name }}";
            const projectGoal = "${{ project.goal_amount }}";
            const totalRaised = "${{ total_raised }}";

            // Add project details at the top of the PDF
            doc.setFontSize(16);
            doc.text(`Project: ${projectName}`, 14, currentY); // Title
            currentY += 8;

            doc.setFontSize(12);
            doc.text(`Goal: ${projectGoal}`, 14, currentY); // Goal
            currentY += 7;
            doc.text(`Raised So Far: ${totalRaised}`, 14, currentY); // Raised So Far

            currentY += 10

            // Get table element
            const table = document.getElementById("transactionsTable");

            if (!table) {
                console.error("Table with id 'transactions' not found!");
                return;
            }

            // Extract headers
            const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());

            // Extract data from rows
            const data = Array.from(table.querySelectorAll("tbody tr")).map(tr => {
                return Array.from(tr.querySelectorAll("td")).map(td => td.textContent.trim());
            });

            // Add table using autoTable
            doc.autoTable({
                head: [headers],
                body: data,
                startY: currentY,
                styles: {
                    head: { fillColor: [95, 140, 166] }, // Customize header color
                    halign: 'left',
                },
            });

            // Save the PDF
            doc.save("Project Specific Transactions.pdf");
        };
    </script>
    <div id="backbutton">
        <a href="{% url 'home' %}" class="btn btn-secondary mt-3">Back</a>
    </div>
</div>
{% endblock %}